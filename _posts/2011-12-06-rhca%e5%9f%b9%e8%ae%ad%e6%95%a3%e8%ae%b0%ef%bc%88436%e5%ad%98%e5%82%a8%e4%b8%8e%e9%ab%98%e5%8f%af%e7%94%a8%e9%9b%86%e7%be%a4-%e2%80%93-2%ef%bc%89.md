---
title: RHCA培训散记（436存储与高可用集群 – 2）
date: 2011-12-06T16:24:55+00:00
layout: post
---
## udev

**1、udev**是Linux kernel 2.6.13之后Linux的设备管理器，是一个运行在用户空间的守护进程；

**2、相比之前的devfs有两大优点**：
  
a>支持设备的固定命名，并不依赖设备被发现的先后顺序；
  
b>从内核空间移动到了用户空间，这样命名的时候就可以利用用户空间的程序了；

**3、udev还负责设备的热拔插管理**；

**4、udev小到可以放进嵌入式设备**；

**5、HAL**：
  
a>HAL是Hardware Abstraction Layer，它帮助上层的应用程序隐藏不必要的细节，本质上是一个设备信息管理器；
  
b>程序负责请求一种设备，HAL负责调度来可用的资源；
  
c>HAL真正管理设备，udev弄出别名给程序员用；
  
d>硬件信息由HAL设备信息配置决定，这些文件存放在/usr/share/hal/fdi和/etc/hal/fdi下，以.fdi后缀结尾；
  
e>可以通过修改.fdi文件达到更改设备属性的目的，数字越小的.fdi越限制性，而后执行的会覆盖前面的属性；
  
f>hald进程维护一个实时的设备数据库，给应用程序提供发现、监控、调用设备的API；

**6、即插即用的事件流程**：
  
a>Kernel发现设备，然后把设备的状态直接导出到sysfs（/sys）；
  
b>udev通过netlink socket得知新设备插入的事件；
  
c>udev根据配置（/etc/udev/rules.d）创建设备节点，如果需要的话执行配置文件中的脚本；
  
d>udev把事件通过socket通知给hald；
  
e>HAL去探测设备信息；
  
f>根据探测到的设备信息和其它一些信息来源（Kernel、配置文件中添加的，硬件信息数据库等）生成设备对象的结构；
  
g>HAL在D-Bus（一种系统信息总线）上广播此事件；
  
h>用户空间里的应用程序收到信息，开始接手处理，比如自动挂载啥的（hald也会收到此事件）；

**7、udevmonitor**可以侦测udev事件；

**8、udev可以做的事**：
  
a>处理设备命名；
  
b>创建设备文件或者链接；
  
c>设置设备文件的属性；
  
d>触发执行一些动作；

**9、udev的配置文件**被放在/etc/udev/内；

**10、用以确定设备id的程序**有：scsi\_id、/lib/udev/ata\_id、/lib/udev/usb_id、udevinfo -a -p $(udevinfo -q path -n /dev/sda1)；



## iSCSI

**1、RFC3720**详述了iSCSI协议；

**2、使用客户端－服务器结构**，服务器端Targetd在RHEL5.3之后的版本中支持；

**3、iSCSI亮点特性**：
  
a>一个32位的校验头，因为tcp自带的16为校验头对长距离大数据的传输来说显得有点弱；
  
b>可支持双向验证（服务器验证客户、客户验证服务器）；
  
c>支持R2T（Ready-to-Transfer）流程（本质上就是二阶段提交，先探测后传输。内置在协议的交换流程中了，在RFC3720 3.5.1.6章节中有详述）；
  
d>支持多路径；
  
e>有突发大数据量写入的机制（细节上就是去掉握手、R2T等过程，这样能简化协议，一定程度上加快数据瞬时写入速度。代价是失败可能性更高。在RFC 12.11.章节中详述）；

**4、iSCSI也用了二阶段提交**，和俺的Colonel一样，说明这么玩还算靠谱，确实能提高可靠性；

**5、PDU**（Protocol Data Unit）协议数据单元；

**6、和其他设备一样，SCSI设备可能会在重启后获得不同的/dev名字**，可以用udev把它固定住（或者直接用uuid、label也成）。注意，不这么搞的话可能会因为设备名错位而 读／写 到错误的设备；

**7、开机挂载**时记得在fstab中要声名“_netdev”，这会告诉系统在网络起来以后再尝试挂载此文件系统，而且在关机时也会自动先使用netfs脚本断开卸载；

**8、IQN**（iSCSI Qualified Name），给iSCSI服务器（Target）端LUNs的命名规范。除了这个规范，还可以遵循eui规范，详见RFC3720 3.2.6.3.；

**9、tgtd**是target端的守护进程，配置文件在/etc/tgt/targets.conf，LUNs也在此配置；

**10、tgtadm**命令用于管理target和LUNs；

**11、iscsid**是客户端对应的守护进程，管理命令是iscsiadm，配置文件在/etc/iscsi/iscsid.conf；

**12、CHAP**（Challenge Handshake Authentication Protocol）点对点询问握手认证协议，用于配置双向验证（Taget和客户端都要配置），用户名和密码均为明文传输，嗅探攻击是可能的，RFC3720中推荐使用IPSec；

**13、CHAP的一些特性**：
  
a>通过递增改变的标识符和可变的询问值，可防止来自端点的重放攻击；
  
b>三次握手；
  
c>可在初始链路建立时完成时，在链路建立之后重复进行；
  
d>更多见http://baike.baidu.com/view/64309.htm和http://tools.ietf.org/html/rfc1994（RFC1994）；

**14、iSCSI初始化等相关信息输出**到dmesg中；

**15、CHAP过程**：
  
a>链路建立阶段结束之后，认证者向对端点发送“challenge”消息。
  
b>对端点用经过单向哈希函数计算出来的值做应答。
  
c>认证者根据它自己计算的哈希值来检查应答，如果值匹配，认证得到承认；否则，连接应该终止。
  
d>经过一定的随机间隔，认证者发送一个新的 challenge 给端点，重复步骤 1 到 3 。

**16、取消iSCSI设备**时要先停止读写，然后登出，然后删除，才行。
